# GaussianHaircut Windows 优化环境配置
# 基于原始 environment.yml，针对 Windows 平台进行了优化
# 使用方法: conda env create -f environment_windows.yml

name: gaussian_splatting_hair
channels:
  - pytorch
  - conda-forge
  - defaults
  - anaconda
  - fvcore
  - iopath
  - bottler
  - nvidia

dependencies:
  # ============================================
  # 核心 Python 环境
  # ============================================
  - python=3.9
  - pip=23.3.1
  - setuptools=69.5.1
  
  # ============================================
  # 编译工具 (Windows 特定)
  # ============================================
  # 注意: Windows 不使用 gcc/gxx，而是使用 MSVC
  # 请确保已安装 Visual Studio Build Tools
  # 原 Linux 依赖已移除:
  # - gcc=10.4.0
  # - gxx=10.4.0
  # - gxx_linux-64=10.4.0
  
  - cmake=3.28.0
  
  # ============================================
  # PyTorch 生态系统
  # ============================================
  - pytorch=2.1.1
  - torchvision=0.16.1
  - torchaudio=2.1.1
  - pytorch-cuda=11.8
  
  # ============================================
  # 3D 处理和可视化
  # ============================================
  - plyfile=0.8.1
  - fvcore=0.1.5
  - iopath=0.1.10
  
  # ============================================
  # 配置和工具
  # ============================================
  - pyhocon=0.3.60
  - icecream=2.1.3
  - toml=0.10.2
  - easydict=1.9
  - jsonmerge=1.9.0
  
  # ============================================
  # 深度学习工具
  # ============================================
  - einops=0.6.0
  - accelerate=0.18.0
  
  # ============================================
  # 可视化和监控
  # ============================================
  - tensorboardx=2.6
  - tqdm=4.66.5
  
  # ============================================
  # 图像处理
  # ============================================
  - scikit-image=0.20.0
  - opencv=4.5.3  # Windows 替代 libopencv-dev
  
  # ============================================
  # 下载工具
  # ============================================
  - gdown=5.2.0
  
  # ============================================
  # COLMAP (相机姿态估计)
  # ============================================
  # 注意: conda 的 COLMAP 可能在 Windows 上有问题
  # 如果安装失败，请从官网下载预编译版本:
  # https://github.com/colmap/colmap/releases
  - colmap=3.10
  
  # ============================================
  # Windows 系统库替代
  # ============================================
  # 这些包替代了 Linux 的系统库
  - protobuf  # 替代 protobuf-compiler
  - boost     # 替代 libboost-all-dev
  - hdf5      # 替代 libhdf5-dev
  - mkl       # 替代 libatlas-base-dev (Intel Math Kernel Library)
  
  # ============================================
  # Pip 安装的包
  # ============================================
  - pip:
    # 纯 Python 包
    - pysdf==0.1.9
    - clean-fid==0.1.35
    - face-alignment==1.4.1
    - clip==0.2.0
    - torchdiffeq==0.2.3
    - torchsde==0.2.5
    - resize-right==0.0.2
    
    # ============================================
    # 自定义 C++/CUDA 扩展
    # ============================================
    # 注意: 这些包需要编译，确保已安装:
    # 1. Visual Studio Build Tools (MSVC)
    # 2. CUDA 11.8
    # 3. CMake 3.20+
    
    # PyTorch3D - 3D 深度学习库
    # 如果编译失败，可以尝试: conda install pytorch3d -c pytorch3d
    - ext/pytorch3d
    
    # NeuralHaircut 的渲染库
    - ext/NeuralHaircut/npbgpp
    
    # 简单的 KNN 实现
    # 如果编译失败，可以使用 scikit-learn 的 NearestNeighbors
    - ext/simple-knn
    
    # 3D 高斯溅射的 CUDA 光栅化器
    # 这是核心组件，必须成功编译
    - ext/diff_gaussian_rasterization_hair
    
    # NVIDIA Kaolin - 3D 深度学习工具包
    # 如果编译失败，某些功能可能不可用
    - ext/kaolin

# ============================================
# 安装说明
# ============================================
# 
# 1. 前置要求:
#    - CUDA 11.8
#    - Visual Studio 2019 或 2022 (包含 C++ 工具)
#    - CMake 3.20+
#
# 2. 创建环境:
#    conda env create -f environment_windows.yml
#
# 3. 激活环境:
#    conda activate gaussian_splatting_hair
#
# 4. 验证安装:
#    python -c "import torch; print(torch.cuda.is_available())"
#
# 5. 如果某些包安装失败:
#    - 检查 Visual Studio Build Tools 是否正确安装
#    - 确认 CUDA_PATH 环境变量已设置
#    - 查看详细错误信息并参考 WINDOWS_COMPATIBILITY_ANALYSIS.md
#
# ============================================
# 已知问题和解决方案
# ============================================
#
# 问题 1: COLMAP 安装失败
# 解决: 从 https://github.com/colmap/colmap/releases 下载预编译版本
#
# 问题 2: PyTorch3D 编译失败
# 解决: conda install pytorch3d -c pytorch3d
#
# 问题 3: Kaolin 编译失败
# 解决: 某些功能可能不可用，但主流程可以继续
#
# 问题 4: "找不到 MSVC"
# 解决: 安装 Visual Studio Build Tools 并重启终端
#
# 问题 5: CUDA 版本不匹配
# 解决: 确保 CUDA 11.8 已正确安装，nvcc --version 应显示 11.8
#
# ============================================
